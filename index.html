<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MuscleMax</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2canvas (ç”»åƒç”Ÿæˆç”¨) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        dark: '#111827',
                        darker: '#0B0F19',
                        surface: '#1F2937'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0B0F19; /* darker */
            color: #F3F4F6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, select, textarea {
            background-color: #374151; border: 1px solid #4B5563; color: white; font-size: 16px;
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: #3B82F6; ring: 2px solid #3B82F6;
        }
        .custom-checkbox:checked { background-color: #3B82F6; border-color: #3B82F6; }
        #loading-overlay { background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ã‚·ã‚§ã‚¢ç”»åƒç”Ÿæˆç”¨ï¼šç”»é¢å¤–ã«é…ç½® */
        #share-capture-area {
            position: absolute;
            top: 0;
            left: -9999px;
            width: 600px; /* å›ºå®šå¹…ã§ãã‚Œã„ã«æç”» */
            background: linear-gradient(135deg, #111827 0%, #1F2937 100%);
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header class="h-14 flex items-center justify-between px-4 bg-surface border-b border-gray-700 shadow-md z-10">
        <h1 class="text-xl font-bold tracking-wider text-primary italic"><i class="fas fa-dumbbell mr-2"></i>MuscleMax</h1>
    </header>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-1 overflow-y-auto overflow-x-hidden relative no-scrollbar pb-20">
        
        <!-- ==================== TAB 1: AI ==================== -->
        <section id="tab-ai" class="p-4 space-y-4 max-w-md mx-auto fade-in">
             <div class="bg-gradient-to-br from-indigo-900 to-purple-900 p-4 rounded-xl shadow-lg border border-indigo-500/30">
                <h2 class="text-lg font-bold text-white mb-2 flex items-center"><i class="fas fa-robot mr-2"></i>AIãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼</h2>
                <p class="text-xs text-gray-300 mb-4">ã‚ãªãŸã®èº«ä½“ã¨ç’°å¢ƒã«åˆã‚ã›ãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs text-gray-300 block mb-1">èº«é•· (cm)</label>
                            <input type="number" id="ai-height" placeholder="170" class="w-full p-2 text-sm rounded bg-indigo-950 border-indigo-700">
                        </div>
                        <div>
                            <label class="text-xs text-gray-300 block mb-1">ä½“é‡ (kg)</label>
                            <input type="number" id="ai-weight" placeholder="65" class="w-full p-2 text-sm rounded bg-indigo-950 border-indigo-700">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-300 block mb-1">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ™‚é–“</label>
                        <select id="ai-time" class="w-full p-2 text-sm rounded bg-indigo-950 border-indigo-700">
                            <option value="30">30åˆ†</option>
                            <option value="45">45åˆ†</option>
                            <option value="60" selected>60åˆ†</option>
                            <option value="90">90åˆ†</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-300 block mb-2">é›ãˆãŸã„éƒ¨ä½ (è¤‡æ•°é¸æŠå¯)</label>
                        <div class="grid grid-cols-2 gap-2" id="ai-parts-container">
                            <label class="flex items-center space-x-2 bg-indigo-950/50 p-2 rounded cursor-pointer hover:bg-indigo-800/50"><input type="checkbox" value="èƒ¸" class="custom-checkbox w-4 h-4 rounded border-gray-500 bg-gray-700 text-primary"><span class="text-sm">èƒ¸</span></label>
                            <label class="flex items-center space-x-2 bg-indigo-950/50 p-2 rounded cursor-pointer hover:bg-indigo-800/50"><input type="checkbox" value="èƒŒä¸­" class="custom-checkbox w-4 h-4 rounded border-gray-500 bg-gray-700 text-primary"><span class="text-sm">èƒŒä¸­</span></label>
                            <label class="flex items-center space-x-2 bg-indigo-950/50 p-2 rounded cursor-pointer hover:bg-indigo-800/50"><input type="checkbox" value="è„š" class="custom-checkbox w-4 h-4 rounded border-gray-500 bg-gray-700 text-primary"><span class="text-sm">è„š</span></label>
                            <label class="flex items-center space-x-2 bg-indigo-950/50 p-2 rounded cursor-pointer hover:bg-indigo-800/50"><input type="checkbox" value="è‚©" class="custom-checkbox w-4 h-4 rounded border-gray-500 bg-gray-700 text-primary"><span class="text-sm">è‚©</span></label>
                            <label class="flex items-center space-x-2 bg-indigo-950/50 p-2 rounded cursor-pointer hover:bg-indigo-800/50"><input type="checkbox" value="è…•(å‰)" class="custom-checkbox w-4 h-4 rounded border-gray-500 bg-gray-700 text-primary"><span class="text-sm">è…•(å‰)</span></label>
                            <label class="flex items-center space-x-2 bg-indigo-950/50 p-2 rounded cursor-pointer hover:bg-indigo-800/50"><input type="checkbox" value="è…•(å¾Œ)" class="custom-checkbox w-4 h-4 rounded border-gray-500 bg-gray-700 text-primary"><span class="text-sm">è…•(å¾Œ)</span></label>
                            <label class="flex items-center space-x-2 bg-indigo-950/50 p-2 rounded cursor-pointer hover:bg-indigo-800/50"><input type="checkbox" value="è…¹" class="custom-checkbox w-4 h-4 rounded border-gray-500 bg-gray-700 text-primary"><span class="text-sm">è…¹</span></label>
                            <label class="flex items-center space-x-2 bg-indigo-950/50 p-2 rounded cursor-pointer hover:bg-indigo-800/50"><input type="checkbox" value="ãã®ä»–" class="custom-checkbox w-4 h-4 rounded border-gray-500 bg-gray-700 text-primary"><span class="text-sm">ãã®ä»–</span></label>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-300 block mb-1">åˆ©ç”¨å¯èƒ½ãªå™¨å…· (ä»»æ„)</label>
                        <textarea id="ai-equipment" rows="3" placeholder="ãƒ‘ãƒ¯ãƒ¼ãƒ©ãƒƒã‚¯, ãƒ€ãƒ³ãƒ™ãƒ«(~30kg), ã‚¹ãƒŸã‚¹ãƒã‚·ãƒ³..." class="w-full p-2 text-sm rounded bg-indigo-950 border-indigo-700"></textarea>
                    </div>
                    <div>
                        <label class="text-xs text-gray-300 block mb-1">ãã®ä»–ã®è¦æœ› (ä»»æ„)</label>
                        <textarea id="ai-request" rows="2" placeholder="ãƒã‚·ãƒ³å¤šã‚ã§, è…°ã«è² æ‹…ã‚’ã‹ã‘ãªã„..." class="w-full p-2 text-sm rounded bg-indigo-950 border-indigo-700"></textarea>
                    </div>
                    <button onclick="askAI()" class="w-full py-3 bg-white text-indigo-900 font-bold rounded shadow hover:bg-gray-100 transition flex justify-center items-center gap-2">
                        <i class="fas fa-magic"></i> ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œæˆ
                    </button>
                </div>
             </div>

             <div id="ai-result" class="hidden space-y-3 fade-in pb-10">
                 <h3 class="font-bold text-gray-300 border-l-4 border-indigo-500 pl-2">ææ¡ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
                 <div id="ai-result-list" class="space-y-2"></div>
                 <button onclick="addAllAIItems()" class="w-full py-3 bg-secondary hover:bg-green-600 text-darker font-bold rounded shadow-lg">å…¨ç¨®ç›®ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
             </div>
        </section>

        <!-- ==================== TAB 2: RECORD ==================== -->
        <section id="tab-record" class="hidden p-4 space-y-6 max-w-md mx-auto">
            <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-300">éƒ¨ä½ & ç¨®ç›®</label>
                <div class="flex gap-2">
                    <select id="input-bodypart" class="w-1/3 p-3 rounded-lg appearance-none" onchange="updateExerciseList()">
                        <option value="èƒ¸">èƒ¸</option><option value="èƒŒä¸­">èƒŒä¸­</option><option value="è„š">è„š</option>
                        <option value="è‚©">è‚©</option><option value="è…•">è…•</option><option value="è…¹">è…¹</option><option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                    <div class="relative w-2/3">
                        <input list="exercise-list" id="input-exercise" type="text" placeholder="ç¨®ç›®ã‚’é¸æŠ/å…¥åŠ›" class="w-full p-3 rounded-lg" onchange="checkHistory()">
                        <datalist id="exercise-list"></datalist>
                        <button onclick="loadPreviousRecord()" id="prev-record-btn" class="hidden absolute right-2 top-2 text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded text-white">å‰å›ã‚’ã‚³ãƒ”ãƒ¼</button>
                    </div>
                </div>
                <div id="prev-record-display" class="text-xs text-gray-400 pl-1 h-4"></div>
            </div>

            <div class="grid grid-cols-3 gap-3">
                <div class="space-y-1">
                    <label class="block text-xs text-gray-400 text-center">é‡é‡ (kg)</label>
                    <div class="flex items-center justify-center bg-gray-700 rounded-lg p-1">
                        <button class="w-8 h-8 text-xl text-primary" onclick="adjustValue('input-weight', -2.5)">-</button>
                        <input type="number" id="input-weight" value="60" class="w-full text-center bg-transparent border-none text-lg font-bold p-0 focus:ring-0">
                        <button class="w-8 h-8 text-xl text-primary" onclick="adjustValue('input-weight', 2.5)">+</button>
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="block text-xs text-gray-400 text-center">å›æ•° (reps)</label>
                    <div class="flex items-center justify-center bg-gray-700 rounded-lg p-1">
                        <button class="w-8 h-8 text-xl text-secondary" onclick="adjustValue('input-reps', -1)">-</button>
                        <input type="number" id="input-reps" value="10" class="w-full text-center bg-transparent border-none text-lg font-bold p-0 focus:ring-0">
                        <button class="w-8 h-8 text-xl text-secondary" onclick="adjustValue('input-reps', 1)">+</button>
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="block text-xs text-gray-400 text-center">ã‚»ãƒƒãƒˆæ•°</label>
                    <div class="flex items-center justify-center bg-gray-700 rounded-lg p-1">
                        <button class="w-8 h-8 text-xl text-purple-400" onclick="adjustValue('input-sets', -1)">-</button>
                        <input type="number" id="input-sets" value="3" class="w-full text-center bg-transparent border-none text-lg font-bold p-0 focus:ring-0">
                        <button class="w-8 h-8 text-xl text-purple-400" onclick="adjustValue('input-sets', 1)">+</button>
                    </div>
                </div>
            </div>

            <div class="space-y-1">
                <label class="block text-xs text-gray-400">ãƒ¡ãƒ¢ (ä»»æ„)</label>
                <input type="text" id="input-memo" placeholder="ãƒ•ã‚©ãƒ¼ãƒ é‡è¦–, ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«çŸ­ã‚ãªã©" class="w-full p-3 rounded-lg text-sm">
            </div>

            <button onclick="addToCart()" class="w-full py-3 bg-gradient-to-r from-primary to-blue-600 rounded-lg font-bold shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                <i class="fas fa-plus"></i> ãƒªã‚¹ãƒˆã«è¿½åŠ 
            </button>

            <div id="cart-container" class="mt-6 border-t border-gray-700 pt-4 hidden">
                <h3 class="text-sm font-semibold text-gray-300 mb-2 flex justify-between items-center">
                    <span><i class="fas fa-shopping-cart mr-1"></i> ä»Šæ—¥ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span>
                    <button onclick="clearCart()" class="text-xs text-red-400">å…¨å‰Šé™¤</button>
                </h3>
                <ul id="cart-list" class="space-y-2 mb-4"></ul>
                <button onclick="submitAll()" class="w-full py-3 bg-secondary hover:bg-green-600 rounded-lg font-bold text-darker shadow-lg active:scale-95 transition-transform animate-pulse">ã™ã¹ã¦ä¿å­˜ã™ã‚‹</button>
            </div>
        </section>

        <!-- ==================== TAB 3: HISTORY ==================== -->
        <section id="tab-history" class="hidden p-4 space-y-4 max-w-md mx-auto">
            <div class="bg-surface rounded-lg p-3 shadow">
                <div class="flex justify-between items-center mb-2">
                    <button onclick="changeMonth(-1)" class="text-gray-400 px-2"><i class="fas fa-chevron-left"></i></button>
                    <span id="calendar-month-label" class="font-bold text-lg"></span>
                    <button onclick="changeMonth(1)" class="text-gray-400 px-2"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center text-xs"></div>
            </div>
            
            <div id="history-header" class="hidden">
                 <div class="flex justify-between items-center border-b border-gray-600 pb-2 mb-2">
                    <h3 class="font-bold text-gray-300" id="history-filter-label"></h3>
                    <div class="flex gap-2">
                        <button onclick="openShareModal()" class="text-xs bg-white text-black px-2 py-1 rounded font-bold flex items-center gap-1 hover:bg-gray-200"><i class="fas fa-share-alt"></i> ã‚·ã‚§ã‚¢</button>
                        <button onclick="clearHistoryFilter()" class="text-xs text-primary">å…¨è¡¨ç¤º</button>
                    </div>
                </div>
            </div>
            
            <div id="history-list" class="space-y-3 pb-20"></div>
        </section>

        <!-- ==================== TAB 4: STATS ==================== -->
        <section id="tab-stats" class="hidden p-4 space-y-6 max-w-md mx-auto">
            <h2 class="text-lg font-bold text-gray-300">ãƒ‡ãƒ¼ã‚¿åˆ†æ</h2>
            <div class="bg-surface p-4 rounded-lg shadow">
                <h3 class="text-sm text-gray-400 mb-2">éƒ¨ä½ãƒãƒ©ãƒ³ã‚¹ (å…¨æœŸé–“ã‚»ãƒƒãƒˆæ•°å‰²åˆ)</h3>
                <div class="h-64 flex justify-center"><canvas id="chart-bodypart"></canvas></div>
            </div>
            <div class="bg-surface p-4 rounded-lg shadow space-y-4">
                <div class="flex flex-col gap-2">
                    <h3 class="text-sm text-gray-400">æˆé•·æ¨ç§» (ç¨®ç›®åˆ¥)</h3>
                    <div class="flex gap-2">
                        <!-- ç¨®ç›®é¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ -->
                        <select id="stats-exercise" onchange="updateProgressChart()" class="flex-1 text-xs p-2 rounded bg-gray-700 border-none text-white max-w-[60%] truncate">
                            <option value="">å±¥æ­´ã‹ã‚‰ç¨®ç›®ã‚’é¸æŠ...</option>
                        </select>
                        <select id="stats-metric" onchange="updateProgressChart()" class="flex-1 text-xs p-2 rounded bg-gray-700 border-none text-white">
                            <option value="1rm">æ¨å®š1RM (kg)</option>
                            <option value="volume">ç·è² è·é‡ (kg)</option>
                            <option value="weight">ä½¿ç”¨é‡é‡ (kg)</option>
                        </select>
                    </div>
                </div>
                <div class="h-48"><canvas id="chart-progress"></canvas></div>
            </div>
        </section>

        <!-- ==================== TAB 5: TOOLS ==================== -->
        <section id="tab-tools" class="hidden p-4 space-y-6 max-w-md mx-auto">
            <h2 class="text-lg font-bold text-gray-300">ãƒ„ãƒ¼ãƒ«</h2>
             <div class="bg-surface p-4 rounded-lg border border-gray-700">
                <h3 class="font-bold mb-3"><i class="fas fa-stopwatch mr-2 text-red-400"></i>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚¿ã‚¤ãƒãƒ¼</h3>
                <div class="flex justify-center items-center gap-4 text-4xl font-mono mb-6 text-white tracking-widest bg-black/30 p-4 rounded-lg">
                    <span id="timer-display">00:00</span>
                </div>
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <button onclick="addTime(30)" class="bg-gray-700 hover:bg-gray-600 py-3 rounded text-sm font-bold shadow">+30ç§’</button>
                    <button onclick="addTime(60)" class="bg-gray-700 hover:bg-gray-600 py-3 rounded text-sm font-bold shadow">+1åˆ†</button>
                    <button onclick="addTime(-30)" class="bg-gray-700 hover:bg-gray-600 py-3 rounded text-sm font-bold shadow">-30ç§’</button>
                </div>
                <div class="flex gap-2">
                    <button id="timer-toggle" onclick="toggleTimer()" class="flex-1 bg-secondary text-darker font-bold py-3 rounded shadow-lg"><i class="fas fa-play mr-1"></i> ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                    <button onclick="resetTimer()" class="w-1/3 bg-red-900/50 text-red-300 font-bold py-3 rounded shadow hover:bg-red-900/80">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
            <div class="bg-surface p-4 rounded-lg border border-gray-700">
                <h3 class="font-bold mb-3"><i class="fas fa-calculator mr-2 text-yellow-400"></i>ãƒ—ãƒ¬ãƒ¼ãƒˆè¨ˆç®—æ©Ÿ</h3>
                <div class="flex gap-2 items-end mb-4">
                    <div class="flex-1">
                        <label class="text-xs text-gray-400">ç›®æ¨™é‡é‡ (kg)</label>
                        <input type="number" id="calc-target" value="100" class="w-full p-2 rounded bg-gray-700">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-gray-400">ãƒãƒ¼é‡é‡</label>
                        <select id="calc-bar" class="w-full p-2 rounded bg-gray-700">
                            <option value="20">20kg</option>
                            <option value="10">10kg</option>
                        </select>
                    </div>
                    <button onclick="calculatePlates()" class="bg-primary px-4 py-2 rounded font-bold">è¨ˆç®—</button>
                </div>
                <div id="plate-result" class="text-sm p-3 bg-gray-900 rounded hidden"></div>
            </div>
        </section>
    </main>

    <!-- Nav -->
    <nav class="h-16 bg-surface border-t border-gray-700 flex justify-around items-center z-20">
        <button onclick="switchTab('ai')" class="nav-btn active flex flex-col items-center text-gray-400 w-full h-full justify-center" data-target="ai"><i class="fas fa-magic text-xl mb-1"></i><span class="text-[10px]">AI</span></button>
        <button onclick="switchTab('record')" class="nav-btn flex flex-col items-center text-gray-400 w-full h-full justify-center" data-target="record"><i class="fas fa-pen text-xl mb-1"></i><span class="text-[10px]">è¨˜éŒ²</span></button>
        <button onclick="switchTab('history')" class="nav-btn flex flex-col items-center text-gray-400 w-full h-full justify-center" data-target="history"><i class="fas fa-calendar-alt text-xl mb-1"></i><span class="text-[10px]">å±¥æ­´</span></button>
        <button onclick="switchTab('stats')" class="nav-btn flex flex-col items-center text-gray-400 w-full h-full justify-center" data-target="stats"><i class="fas fa-chart-line text-xl mb-1"></i><span class="text-[10px]">åˆ†æ</span></button>
        <button onclick="switchTab('tools')" class="nav-btn flex flex-col items-center text-gray-400 w-full h-full justify-center" data-target="tools"><i class="fas fa-ellipsis-h text-xl mb-1"></i><span class="text-[10px]">ãƒ„ãƒ¼ãƒ«</span></button>
    </nav>

    <!-- UI Elements -->
    <div id="loading-overlay" class="fixed inset-0 z-50 hidden flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent mb-3"></div>
        <p class="text-white font-bold tracking-widest">LOADING</p>
    </div>
    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-xl z-50 transition-opacity duration-300 opacity-0 pointer-events-none border border-gray-600 flex items-center gap-2">
        <i class="fas fa-info-circle text-primary"></i> <span id="toast-msg">Message</span>
    </div>

    <!-- ã‚·ã‚§ã‚¢ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="share-modal" class="fixed inset-0 z-50 hidden bg-black/90 flex flex-col items-center justify-center p-4">
        <div class="bg-gray-800 p-4 rounded-xl max-w-sm w-full space-y-4">
            <div class="flex justify-between items-center text-gray-300">
                <h3 class="font-bold">ç”»åƒã‚’ã‚·ã‚§ã‚¢</h3>
                <button onclick="closeShareModal()" class="text-2xl">&times;</button>
            </div>
            
            <div class="bg-black/50 p-2 rounded flex justify-center border border-gray-700 overflow-hidden">
                <!-- ç”Ÿæˆã•ã‚ŒãŸç”»åƒãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                <img id="share-preview-img" class="max-w-full h-auto rounded shadow-lg" alt="Workout Summary">
            </div>

            <p class="text-xs text-center text-gray-400">
                ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜ã—ã€<br>XæŠ•ç¨¿æ™‚ã«æ·»ä»˜ã—ã¦ãã ã•ã„ã€‚
            </p>

            <button onclick="shareToX()" class="w-full py-3 bg-black text-white font-bold rounded-lg border border-gray-600 hover:bg-gray-900 transition flex items-center justify-center gap-2">
                <i class="fab fa-x-twitter text-lg"></i> Xã§ãƒã‚¹ãƒˆã‚’ä½œæˆ
            </button>
        </div>
    </div>

    <!-- ç”»åƒç”Ÿæˆç”¨éš ã—è¦ç´  (ã“ã®å†…å®¹ãŒç”»åƒã«ãªã‚Šã¾ã™) -->
    <div id="share-capture-area" class="p-8 text-white font-sans">
        <div class="border-4 border-white/20 rounded-2xl p-6 bg-white/5 backdrop-blur-sm">
            <div class="flex justify-between items-center mb-6 border-b border-white/20 pb-4">
                <div>
                    <h1 class="text-3xl font-black italic tracking-tighter text-blue-400">MuscleMax</h1>
                    <p class="text-sm text-gray-400">WORKOUT LOG</p>
                </div>
                <div class="text-right">
                    <div id="share-date" class="text-2xl font-bold"></div>
                    <div class="text-sm text-green-400 font-mono">COMPLETED</div>
                </div>
            </div>
            
            <div id="share-list" class="space-y-4 mb-6">
                <!-- ãƒªã‚¹ãƒˆãŒJSã§æ³¨å…¥ã•ã‚Œã¾ã™ -->
            </div>

            <div class="flex justify-between items-end pt-4 border-t border-white/20">
                <div class="text-center">
                    <p class="text-xs text-gray-500">TOTAL VOLUME</p>
                    <p id="share-volume" class="text-2xl font-black text-yellow-400">0<span class="text-sm text-gray-400 ml-1">kg</span></p>
                </div>
                <div class="text-xs text-gray-500">
                    generated by MuscleMax
                </div>
            </div>
        </div>
    </div>

    <!-- JS Logic -->
    <script>
        // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š (ã“ã“ã«æ•°å€¤ã‚’æ›¸ã„ã¦å›ºå®šï¼) â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
        const USER_CONFIG = {
            // Gemini APIã‚­ãƒ¼ (GASã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§è¨­å®šã—ãªã„å ´åˆã¯ã“ã“ã«å…¥åŠ›)
            GEMINI_API_KEY: "", 

            // â˜…ã“ã“ã«å›ºå®šã—ãŸã„æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„â˜…
            DEFAULT_HEIGHT: 170,    // èº«é•·(cm) ä¾‹: 175
            DEFAULT_WEIGHT: 65,     // ä½“é‡(kg) ä¾‹: 70
            
            // â˜…åˆ©ç”¨å¯èƒ½ãªå™¨å…·ã‚’ã“ã“ã«å›ºå®šã—ã¦ãã ã•ã„â˜…
            DEFAULT_EQUIPMENT: ""
        };
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const APP_STATE = { currentTab: 'ai', cart: [], history: [], timer: { interval: null, timeLeft: 0, isRunning: false }, aiResults: [] };
              // â˜…ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”¨ã®å˜èªâ˜…
        const EXERCISE_DB = {
            'èƒ¸': ['ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹', 'ãƒ€ãƒ³ãƒ™ãƒ«ãƒ•ãƒ©ã‚¤', 'ã‚¤ãƒ³ã‚¯ãƒ©ã‚¤ãƒ³ãƒ™ãƒ³ãƒ', 'ãƒ—ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—'],
            'èƒŒä¸­': ['ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ', 'æ‡¸å‚', 'ãƒ©ãƒƒãƒˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³', 'ãƒ¯ãƒ³ãƒãƒ³ãƒ‰ãƒ­ãƒ¼'],
            'è„š': ['ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ', 'ãƒ¬ãƒƒã‚°ãƒ—ãƒ¬ã‚¹', 'ãƒ¬ãƒƒã‚°ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³', 'ã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚º'],
            'è‚©': ['ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼ãƒ—ãƒ¬ã‚¹', 'ã‚µã‚¤ãƒ‰ãƒ¬ã‚¤ã‚º', 'ãƒªã‚¢ãƒ‡ãƒ«ãƒˆ', 'ã‚¢ãƒƒãƒ—ãƒ©ã‚¤ãƒˆãƒ­ãƒ¼'],
            'è…•': ['ã‚¢ãƒ¼ãƒ ã‚«ãƒ¼ãƒ«', 'ãƒ•ãƒ¬ãƒ³ãƒãƒ—ãƒ¬ã‚¹', 'ãƒˆãƒ©ã‚¤ã‚»ãƒ—ã‚¹ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³'],
            'è…¹': ['ã‚¯ãƒ©ãƒ³ãƒ', 'ãƒ¬ãƒƒã‚°ãƒ¬ã‚¤ã‚º', 'ãƒ—ãƒ©ãƒ³ã‚¯'],
            'ãã®ä»–': ['ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°', 'æœ‰é…¸ç´ é‹å‹•']
        };

        window.onload = function() {
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                // alert("è­¦å‘Š: ã“ã®ã‚¢ãƒ—ãƒªã¯Google Apps Scriptç’°å¢ƒã§å‹•ä½œã—ã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼é€šä¿¡æ©Ÿèƒ½ã¯ç„¡åŠ¹ã§ã™ã€‚");
                // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
                APP_STATE.history = [
                    {dateStr:'2023-10-25', bodyPart:'èƒ¸', exercise:'ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹', weight:80, reps:10, sets:3},
                    {dateStr:'2023-10-25', bodyPart:'èƒ¸', exercise:'ã‚¤ãƒ³ã‚¯ãƒ©ã‚¤ãƒ³ãƒ€ãƒ³ãƒ™ãƒ«', weight:24, reps:10, sets:3},
                    {dateStr:'2023-10-25', bodyPart:'è…•', exercise:'ã‚¢ãƒ¼ãƒ ã‚«ãƒ¼ãƒ«', weight:15, reps:12, sets:3},
                ];
                renderCalendar();
            } else {
                fetchHistory();
            }
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®åæ˜ 
            document.getElementById('ai-height').value = USER_CONFIG.DEFAULT_HEIGHT;
            document.getElementById('ai-weight').value = USER_CONFIG.DEFAULT_WEIGHT;
            document.getElementById('ai-equipment').value = USER_CONFIG.DEFAULT_EQUIPMENT;

            updateExerciseList();
            renderCalendar();
            switchTab('ai');
        };

        function switchTab(tabId) {
            APP_STATE.currentTab = tabId;
            document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-primary', 'active');
                btn.classList.add('text-gray-400');
                if (btn.dataset.target === tabId) { btn.classList.add('text-primary', 'active'); btn.classList.remove('text-gray-400'); }
            });
            if (tabId === 'history') { clearHistoryFilter(); renderHistoryList(); }
            if (tabId === 'stats') { renderCharts(); }
        }

        // --- Input & Cart ---
        function updateExerciseList() {
            const bodyPart = document.getElementById('input-bodypart').value;
            const datalist = document.getElementById('exercise-list');
            datalist.innerHTML = '';
            (EXERCISE_DB[bodyPart] || []).forEach(ex => {
                const option = document.createElement('option');
                option.value = ex;
                datalist.appendChild(option);
            });
            document.getElementById('input-exercise').value = '';
        }

        function adjustValue(id, delta) {
            const el = document.getElementById(id);
            let val = parseFloat(el.value) || 0;
            val += delta;
            if (id === 'input-weight') val = Math.round(val * 10) / 10;
            if (val < 0) val = 0;
            el.value = val;
        }

        function checkHistory() {
            const exercise = document.getElementById('input-exercise').value;
            if (!exercise) return;
            const prev = APP_STATE.history.find(h => h.exercise === exercise);
            const display = document.getElementById('prev-record-display');
            const btn = document.getElementById('prev-record-btn');
            if (prev) {
                const d = prev.dateStr ? prev.dateStr.slice(5).split(' ')[0] : '--';
                display.textContent = `å‰å›: ${prev.weight}kg x ${prev.reps} (${d})`;
                btn.onclick = () => {
                    document.getElementById('input-weight').value = prev.weight;
                    document.getElementById('input-reps').value = prev.reps;
                    document.getElementById('input-sets').value = prev.sets;
                    showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                };
                btn.classList.remove('hidden');
            } else {
                display.textContent = 'è¨˜éŒ²ãªã—';
                btn.classList.add('hidden');
            }
        }

        function addToCart(aiItem = null) {
            let item;
            if (aiItem) {
                item = { ...aiItem, id: Date.now(), score: aiItem.weight * (1 + (aiItem.reps/40)) };
            } else {
                const bodyPart = document.getElementById('input-bodypart').value;
                const exercise = document.getElementById('input-exercise').value;
                const weight = parseFloat(document.getElementById('input-weight').value);
                const reps = parseInt(document.getElementById('input-reps').value);
                const sets = parseInt(document.getElementById('input-sets').value);
                const memo = document.getElementById('input-memo').value;
                if (!exercise) { showToast('ç¨®ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
                item = { id: Date.now(), date: new Date().toISOString(), bodyPart, exercise, weight, reps, sets, memo, score: weight * (1 + (reps / 40)) };
                showToast(`${exercise} ã‚’è¿½åŠ `);
            }
            APP_STATE.cart.push(item);
            renderCart();
            document.getElementById('cart-container').classList.remove('hidden');
            if(aiItem) showToast('ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ');
        }

        function updateCartMemo(index, val) { if(APP_STATE.cart[index]) APP_STATE.cart[index].memo = val; }
        function updateCartValue(index, key, val) {
            if (APP_STATE.cart[index]) {
                APP_STATE.cart[index][key] = parseFloat(val);
                // é‡é‡ã‹å›æ•°ãŒå¤‰ã‚ã£ãŸã‚‰ã‚¹ã‚³ã‚¢(1RMæ›ç®—)ã‚‚å†è¨ˆç®—ã—ã¦æ•´åˆæ€§ã‚’ä¿ã¤
                if (key === 'weight' || key === 'reps') {
                    const w = APP_STATE.cart[index].weight || 0;
                    const r = APP_STATE.cart[index].reps || 0;
                    APP_STATE.cart[index].score = w * (1 + (r / 40));
                }
            }
        }
       
        function renderCart() {
            const list = document.getElementById('cart-list');
            list.innerHTML = '';
            APP_STATE.cart.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'bg-gray-800 p-4 rounded-lg text-sm border-l-4 border-primary shadow-sm mb-3';
                li.innerHTML = `
                    <div class="mb-2">
                        <div class="flex justify-between items-start mb-2">
                            <a href="https://www.google.com/search?q=${encodeURIComponent(item.exercise + ' ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°')}" target="_blank" rel="noopener noreferrer" class="font-bold text-lg text-white hover:text-primary flex items-center gap-2 group decoration-dotted underline underline-offset-4">
                                ${item.exercise} <i class="fas fa-search text-xs text-gray-500 group-hover:text-primary"></i>
                            </a>
                            <span class="bg-gray-700 text-xs px-2 py-1 rounded text-gray-300">${item.bodyPart}</span>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <div>
                                <label class="text-[10px] text-gray-400 block text-center mb-1">é‡é‡(kg)</label>
                                <input type="number" step="0.5" value="${item.weight}" onchange="updateCartValue(${index}, 'weight', this.value)" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-center text-primary font-bold text-lg focus:border-primary outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-400 block text-center mb-1">å›æ•°</label>
                                <input type="number" value="${item.reps}" onchange="updateCartValue(${index}, 'reps', this.value)" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-center text-white font-bold text-lg focus:border-primary outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-400 block text-center mb-1">ã‚»ãƒƒãƒˆ</label>
                                <input type="number" value="${item.sets}" onchange="updateCartValue(${index}, 'sets', this.value)" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-center text-white font-bold text-lg focus:border-primary outline-none">
                            </div>
                        </div>

                        <input type="text" value="${item.memo || ''}" placeholder="ãƒ¡ãƒ¢ (ä»»æ„)" class="w-full bg-gray-900/50 border border-gray-600 rounded p-2 text-gray-200 outline-none focus:border-primary transition-colors" oninput="updateCartMemo(${index}, this.value)">
                    </div>
                    <div class="flex gap-3 mt-3 pt-2 border-t border-gray-700/50">
                        <button onclick="removeFromCart(${index})" class="flex items-center justify-center px-4 py-2 bg-gray-700 text-red-400 rounded-lg hover:bg-gray-600 active:scale-95 transition-all h-11 w-14">
                            <i class="fas fa-trash-alt text-lg"></i>
                        </button>
                        <button onclick="saveSingleItem(${index})" class="flex-1 flex items-center justify-center px-4 py-2 bg-secondary text-darker font-bold rounded-lg hover:bg-green-500 active:scale-95 transition-all h-11 gap-2 shadow-lg">
                            <i class="fas fa-check"></i> ã“ã®1ä»¶ã‚’è¨˜éŒ²
                        </button>
                    </div>`;
                list.appendChild(li);
            });
            if (APP_STATE.cart.length === 0) document.getElementById('cart-container').classList.add('hidden');
        }
        
        function removeFromCart(index) { APP_STATE.cart.splice(index, 1); renderCart(); }
        function clearCart() { if(confirm('ç©ºã«ã—ã¾ã™ã‹ï¼Ÿ')) { APP_STATE.cart = []; renderCart(); } }

        // --- Save ---
        function saveSingleItem(index) {
            if(!confirm(`${APP_STATE.cart[index].exercise} ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            submitData([APP_STATE.cart[index]], () => removeFromCart(index));
        }

        function submitAll() {
            if (APP_STATE.cart.length === 0) return;
            if(!confirm('ã™ã¹ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) return;
            submitData(APP_STATE.cart, () => { APP_STATE.cart = []; renderCart(); });
        }

        function submitData(items, callback) {
            showLoading(true);
            const payload = items.map(item => ({
                date: new Date().toISOString(), bodyPart: item.bodyPart, exercise: item.exercise,
                weight: item.weight, reps: item.reps, sets: item.sets, score: item.score, memo: item.memo || ''
            }));

            if (typeof google === 'undefined') {
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨
                setTimeout(() => {
                    items.forEach(i => {
                        APP_STATE.history.unshift({...i, dateStr: new Date().toISOString().split('T')[0]});
                    });
                    showLoading(false); showToast('ä¿å­˜å®Œäº†'); callback(); fetchHistory(); switchTab('history');
                }, 1000);
                return;
            }

            google.script.run.withSuccessHandler(() => {
                showLoading(false); showToast('ä¿å­˜å®Œäº†'); callback(); fetchHistory(); switchTab('history');
            }).withFailureHandler(err => {
                showLoading(false); alert('Error: ' + err);
            }).saveWorkout(payload);
        }

        // --- History ---
        let historyFilterDate = null;
        function fetchHistory() {
            if (typeof google === 'undefined') { renderHistoryList(); return; }
            showLoading(true);
            google.script.run.withSuccessHandler(data => {
                APP_STATE.history = JSON.parse(data);
                showLoading(false); renderHistoryList(); renderCalendar();
            }).withFailureHandler(err => { showLoading(false); console.error(err); }).getHistoryJSON();
        }

        function renderHistoryList() {
            const container = document.getElementById('history-list');
            const headerLabel = document.getElementById('history-filter-label');
            const headerDiv = document.getElementById('history-header');
            container.innerHTML = '';
            
            let displayData = APP_STATE.history;
            if (historyFilterDate) {
                displayData = APP_STATE.history.filter(item => (item.dateStr || item.date).startsWith(historyFilterDate));
                headerLabel.textContent = `${historyFilterDate.split('-')[1]}æœˆ${historyFilterDate.split('-')[2]}æ—¥ (${displayData.length}ä»¶)`;
                headerDiv.classList.remove('hidden');
            } else { headerDiv.classList.add('hidden'); }

            if (displayData.length === 0) { container.innerHTML = '<div class="text-center text-gray-500 py-10">è¨˜éŒ²ãªã—</div>'; return; }

            displayData.forEach(item => {
                const dateDisplay = (item.dateStr || '').slice(5, 16);
                const card = document.createElement('div');
                card.className = 'bg-surface p-3 rounded-lg shadow border-l-4 border-secondary flex justify-between';
                card.innerHTML = `
                    <div class="w-full">
                        <div class="text-xs text-gray-400 mb-1">${dateDisplay} <span class="ml-2 bg-gray-700 px-1 rounded text-[10px]">${item.bodyPart}</span></div>
                        <div class="font-bold text-lg">${item.exercise}</div>
                        <div class="text-sm flex justify-between mt-1"><span><span class="text-primary font-bold text-lg">${item.weight}</span>kg x ${item.reps} x ${item.sets}</span><span class="text-xs text-gray-500">Vol: ${item.weight*item.reps*item.sets}</span></div>
                        ${item.memo ? `<div class="text-xs text-gray-500 mt-1 border-t border-gray-700 pt-1"><i class="fas fa-sticky-note mr-1"></i>${item.memo}</div>` : ''}
                    </div>`;
                container.appendChild(card);
            });
        }
        
        function clearHistoryFilter() { historyFilterDate = null; renderHistoryList(); }
        
        let currentCalendarDate = new Date();
        function changeMonth(delta) { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta); renderCalendar(); }
        function renderCalendar() {
            const y = currentCalendarDate.getFullYear(), m = currentCalendarDate.getMonth();
            document.getElementById('calendar-month-label').textContent = `${y}å¹´ ${m + 1}æœˆ`;
            const firstDay = new Date(y, m, 1).getDay(), lastDate = new Date(y, m + 1, 0).getDate();
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(d => grid.innerHTML += `<div class="text-gray-500 py-1 font-bold">${d}</div>`);
            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;

            const trainedDays = new Set();
            const currentMonthStr = `${y}-${(m + 1).toString().padStart(2, '0')}`;
            APP_STATE.history.forEach(h => {
                const dStr = h.dateStr || h.date;
                if (dStr && dStr.startsWith(currentMonthStr)) trainedDays.add(parseInt(dStr.split('-')[2]));
            });

            for (let d = 1; d <= lastDate; d++) {
                const dayStr = `${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                let className = "py-2 rounded cursor-pointer transition ";
                if (historyFilterDate === dayStr) className += "bg-primary text-white font-bold ring-2 ring-white";
                else if (trainedDays.has(d)) className += "bg-green-600 text-white border border-green-500 font-bold hover:bg-green-500";
                else className += "text-gray-500 hover:bg-gray-800";
                
                const cell = document.createElement('div');
                cell.className = className;
                cell.textContent = d;
                cell.onclick = () => { historyFilterDate = dayStr; renderCalendar(); renderHistoryList(); document.getElementById('history-header').scrollIntoView({behavior: 'smooth'}); };
                grid.appendChild(cell);
            }
        }

        // --- Share Feature ---
        function openShareModal() {
            showLoading(true);
            
            // 1. ã‚·ã‚§ã‚¢ç”¨ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
            const dateStr = historyFilterDate || new Date().toISOString().split('T')[0];
            const dataToShare = APP_STATE.history.filter(item => (item.dateStr || item.date).startsWith(dateStr));
            
            if (dataToShare.length === 0) {
                showLoading(false);
                alert("è¡¨ç¤ºã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“");
                return;
            }

            // 2. DOMã®æ§‹ç¯‰ (éš ã—è¦ç´ ã¸æ³¨å…¥)
            document.getElementById('share-date').textContent = `${dateStr.split('-')[0]}.${dateStr.split('-')[1]}.${dateStr.split('-')[2]}`;
            const listContainer = document.getElementById('share-list');
            listContainer.innerHTML = '';
            
            let totalVol = 0;
            // æœ€å¤§8ä»¶ã¾ã§è¡¨ç¤ºï¼ˆç”»åƒãŒé•·ããªã‚Šã™ããªã„ã‚ˆã†ã«ï¼‰
            dataToShare.slice(0, 8).forEach(item => {
                totalVol += (item.weight * item.reps * item.sets);
                const row = document.createElement('div');
                row.className = 'flex justify-between items-center bg-white/10 p-3 rounded-lg';
                row.innerHTML = `
                    <div>
                        <div class="text-lg font-bold text-white">${item.exercise}</div>
                        <div class="text-xs text-gray-300 bg-blue-500/30 px-2 py-0.5 rounded inline-block mt-1">${item.bodyPart}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-mono font-bold text-blue-300">${item.weight}<span class="text-sm text-gray-400">kg</span></div>
                        <div class="text-xs text-gray-400">${item.sets} set / ${item.reps} reps</div>
                    </div>
                `;
                listContainer.appendChild(row);
            });
            if (dataToShare.length > 8) {
                const more = document.createElement('div');
                more.className = "text-center text-sm text-gray-400 italic mt-2";
                more.textContent = `+ ${dataToShare.length - 8} more exercises...`;
                listContainer.appendChild(more);
            }
            
            document.getElementById('share-volume').innerHTML = `${totalVol.toLocaleString()}<span class="text-sm text-gray-400 ml-1">kg</span>`;

            // 3. html2canvasã§ç”»åƒåŒ–
            const target = document.getElementById('share-capture-area');
            html2canvas(target, {
                scale: 2, // é«˜è§£åƒåº¦
                backgroundColor: null,
                logging: false,
                useCORS: true
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                document.getElementById('share-preview-img').src = imgData;
                showLoading(false);
                document.getElementById('share-modal').classList.remove('hidden');
            }).catch(err => {
                showLoading(false);
                alert('ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
            });
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.add('hidden');
        }

        function shareToX() {
            const dateStr = historyFilterDate || new Date().toISOString().split('T')[0];
            const vol = document.getElementById('share-volume').innerText;
            const text = `MuscleMaxã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å®Œäº†ï¼ğŸ’ª\næ—¥ä»˜: ${dateStr}\nç·è² è·é‡: ${vol}\n\n#MuscleMax #ç­‹ãƒˆãƒ¬è¨˜éŒ²`;
            
            // ç”»åƒæ·»ä»˜ã¯APIåˆ¶é™ã®ãŸã‚ã§ããªã„ã®ã§ã€ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã§ãƒ„ã‚¤ãƒ¼ãƒˆç”»é¢ã‚’é–‹ã
            const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        // --- Charts & Analysis ---
        let progressChart = null, bodyPartChart = null;
        
        function renderCharts() {
            if (APP_STATE.history.length === 0) return;

            // 1. éƒ¨ä½ãƒãƒ©ãƒ³ã‚¹ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
            const counts = { 'èƒ¸':0, 'èƒŒä¸­':0, 'è„š':0, 'è‚©':0, 'è…•':0, 'è…¹':0, 'ãã®ä»–':0 };
            APP_STATE.history.forEach(h => {
                if (counts[h.bodyPart] !== undefined) counts[h.bodyPart] += (h.sets || 1);
                else counts['ãã®ä»–'] += (h.sets || 1);
            });

            if (!bodyPartChart) {
                bodyPartChart = new Chart(document.getElementById('chart-bodypart').getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(counts),
                        datasets: [{ 
                            data: Object.values(counts), 
                            backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#6B7280'], 
                            borderWidth: 0 
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#fff', font: {size: 10} } } } }
                });
            } else {
                bodyPartChart.data.datasets[0].data = Object.values(counts);
                bodyPartChart.update();
            }

            // 2. ç¨®ç›®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®æ›´æ–°
            updateStatsExerciseList();
            
            // 3. æ¨ç§»ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
            updateProgressChart();
        }

        function updateStatsExerciseList() {
            const select = document.getElementById('stats-exercise');
            const currentVal = select.value;
            // å±¥æ­´ã‹ã‚‰ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªç¨®ç›®ã‚’æŠ½å‡º
            const exercises = [...new Set(APP_STATE.history.map(h => h.exercise))].sort();
            
            select.innerHTML = '<option value="">ç¨®ç›®ã‚’é¸æŠ...</option>';
            exercises.forEach(ex => {
                const option = document.createElement('option');
                option.value = ex;
                option.textContent = ex;
                select.appendChild(option);
            });

            if (exercises.includes(currentVal)) {
                select.value = currentVal;
            } else if (exercises.length > 0) {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ€æ–°ã®ç¨®ç›®ã‚’é¸æŠã™ã‚‹ç­‰ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚‚å¯
                select.value = exercises[0]; 
            }
        }

        function updateProgressChart() {
            const ctx = document.getElementById('chart-progress').getContext('2d');
            const targetExercise = document.getElementById('stats-exercise').value;
            const metric = document.getElementById('stats-metric').value; // 1rm, volume, weight
            
            // ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
            let chartData = [];
            let chartLabels = [];
            
            if (targetExercise) {
                // å¯¾è±¡ç¨®ç›®ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¤ã„é †ã«ä¸¦ã¹ã‚‹
                const filtered = APP_STATE.history
                    .filter(h => h.exercise === targetExercise)
                    .sort((a, b) => new Date(a.dateStr) - new Date(b.dateStr));
                
                filtered.forEach(h => {
                    chartLabels.push(h.dateStr.slice(5, 10)); // MM-DD
                    let val = 0;
                    if (metric === '1rm') val = h.score || (h.weight * (1 + h.reps/40));
                    else if (metric === 'volume') val = h.weight * h.reps * h.sets;
                    else val = h.weight;
                    chartData.push(val);
                });
            }

            if (progressChart) progressChart.destroy();
            
            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{ 
                        label: targetExercise || 'ç¨®ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„', 
                        data: chartData, 
                        borderColor: '#3B82F6', 
                        backgroundColor: 'rgba(59, 130, 246, 0.1)', 
                        tension: 0.2, 
                        fill: true 
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { grid: { color: '#374151' }, ticks: { color: '#9CA3AF' } }, 
                        x: { grid: { display: false }, ticks: { color: '#9CA3AF', maxTicksLimit: 6 } } 
                    }, 
                    plugins: { legend: { display: true, labels: {color: '#fff'} } } 
                }
            });
        }

        // --- Timer ---
        function updateTimerDisplay() {
            const m = Math.floor(APP_STATE.timer.timeLeft / 60).toString().padStart(2, '0');
            const s = Math.abs(APP_STATE.timer.timeLeft % 60).toString().padStart(2, '0');
            const display = document.getElementById('timer-display');
            display.textContent = `${m}:${s}`;
            if (APP_STATE.timer.timeLeft < 0) display.classList.add('text-red-500'); else display.classList.remove('text-red-500');
        }
        function addTime(sec) { APP_STATE.timer.timeLeft = Math.max(0, APP_STATE.timer.timeLeft + sec); updateTimerDisplay(); }
        function toggleTimer() {
            const btn = document.getElementById('timer-toggle');
            if (APP_STATE.timer.isRunning) {
                clearInterval(APP_STATE.timer.interval);
                APP_STATE.timer.isRunning = false;
                btn.innerHTML = '<i class="fas fa-play mr-1"></i> å†é–‹'; btn.classList.replace('bg-yellow-600', 'bg-secondary');
            } else {
                if (APP_STATE.timer.timeLeft <= 0) addTime(60);
                APP_STATE.timer.isRunning = true;
                btn.innerHTML = '<i class="fas fa-pause mr-1"></i> ä¸€æ™‚åœæ­¢'; btn.classList.replace('bg-secondary', 'bg-yellow-600');
                APP_STATE.timer.interval = setInterval(() => { APP_STATE.timer.timeLeft--; updateTimerDisplay(); if (APP_STATE.timer.timeLeft === 0) navigator.vibrate([200]); }, 1000);
            }
        }
        function resetTimer() {
            clearInterval(APP_STATE.timer.interval);
            APP_STATE.timer.isRunning = false; APP_STATE.timer.timeLeft = 0; updateTimerDisplay();
            const btn = document.getElementById('timer-toggle'); btn.innerHTML = '<i class="fas fa-play mr-1"></i> ã‚¹ã‚¿ãƒ¼ãƒˆ'; btn.classList.replace('bg-yellow-600', 'bg-secondary');
        }

        // --- Calc ---
        function calculatePlates() {
            const target = parseFloat(document.getElementById('calc-target').value), bar = parseFloat(document.getElementById('calc-bar').value);
            if (!target || target < bar) { alert('é‡é‡è¨­å®šã‚¨ãƒ©ãƒ¼'); return; }
            let remaining = (target - bar) / 2, result = [];
            [25, 20, 15, 10, 5, 2.5, 1.25].forEach(p => { const c = Math.floor(remaining / p); if (c > 0) { result.push(`${p}kg x ${c}`); remaining -= c * p; } });
            document.getElementById('plate-result').innerHTML = `<div class="text-xs text-gray-400">ç‰‡å´: ${(target-bar)/2}kg</div><div class="font-bold text-lg text-primary mt-1">${result.join(', ') || 'ãªã—'}</div>`;
            document.getElementById('plate-result').classList.remove('hidden');
        }

        // --- AI ---
        function askAI() {
            const height = document.getElementById('ai-height').value;
            const weight = document.getElementById('ai-weight').value;
            const time = document.getElementById('ai-time').value;
            const eq = document.getElementById('ai-equipment').value;
            const req = document.getElementById('ai-request').value;
            
            const parts = Array.from(document.querySelectorAll('#ai-parts-container input:checked')).map(cb => cb.value);
            if (parts.length === 0) { alert('éƒ¨ä½ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            
            showLoading(true);
            
            // â˜…å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ (æœ€å¤§30ä»¶)
            const historyContext = APP_STATE.history.slice(0, 30).map(h => {
                const d = h.dateStr ? h.dateStr.split(' ')[0] : 'ä¸æ˜';
                return `- ${d}: ${h.exercise} (${h.bodyPart}) ${h.weight}kg x ${h.reps} x ${h.sets}`;
            }).join('\n');

            const prompt = `
ä»¥ä¸‹ã®æ¡ä»¶ã¨éå»ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å±¥æ­´ã«åŸºã¥ã„ã¦ã€æœ€é©ãªç­‹ãƒˆãƒ¬ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
ç‰¹ã«ã€æ¼¸é€²æ€§éè² è·ã®åŸå‰‡ï¼ˆå‰å›ã®è¨˜éŒ²ã‚ˆã‚Šå°‘ã—è² è·ã‚’ä¸Šã’ã‚‹ã€å›æ•°ã‚’å¢—ã‚„ã™ãªã©ï¼‰ã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚
ã¾ãŸã€ç¨®ç›®ã®ç‰¹æ€§ã‚’æ´»ã‹ã—ãŸè¨­å®šï¼ˆã‚³ãƒ³ãƒ‘ã‚¦ãƒ³ãƒ‰ç¨®ç›®ã¯é«˜é‡é‡Ã—ä½å›æ•°ã€ãƒã‚·ãƒ³ã§ã®ã‚³ãƒ³ãƒ‘ã‚¦ãƒ³ãƒ‰ç¨®ç›®ã¯ä¸­é‡é‡Ã—ä¸­å›æ•°ã€ã‚¢ã‚¤ã‚½ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç¨®ç›®ã¯ä½é‡é‡Ã—é«˜å›æ•°ï¼‰ã«ãªã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€‘
ãƒ»èº«é•·: ${height}cm
ãƒ»ä½“é‡: ${weight}kg

ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ¡ä»¶ã€‘
ãƒ»ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ™‚é–“: ${time}åˆ†
ãƒ»ã‚¿ãƒ¼ã‚²ãƒƒãƒˆéƒ¨ä½: ${parts.join(', ')}
ãƒ»åˆ©ç”¨å¯èƒ½ãªå™¨å…·: ${eq || 'ç‰¹ã«æŒ‡å®šãªã—'}
ãƒ»ãã®ä»–ã®è¦æœ›: ${req || 'ç‰¹ã«æŒ‡å®šãªã—'}

ã€ç›´è¿‘ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å±¥æ­´ã€‘
${historyContext || 'å±¥æ­´ãªã—'}

ã“ã‚Œã‚‰ã®æ¡ä»¶ã‚’æº€ãŸã™å…·ä½“çš„ãªç¨®ç›®ã€é‡é‡(ç›®å®‰)ã€å›æ•°ã€ã‚»ãƒƒãƒˆæ•°ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚
            `;

            if (typeof google === 'undefined') {
                // ãƒ‡ãƒ¢ç”¨
                 setTimeout(() => {
                    const mockData = [
                        {exercise: 'ãƒ‡ãƒ¢: ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹', weight: 60, reps: 10, sets: 3, bodyPart: 'èƒ¸', memo: 'ã—ã£ã‹ã‚Šèƒ¸ã‚’å¼µã‚‹'},
                        {exercise: 'ãƒ‡ãƒ¢: ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ', weight: 80, reps: 10, sets: 3, bodyPart: 'è„š', memo: 'è†ãŒã¤ã¾å…ˆã‚ˆã‚Šå‰ã«å‡ºãªã„ã‚ˆã†ã«'}
                    ];
                    APP_STATE.aiResults = mockData;
                    const container = document.getElementById('ai-result-list'); container.innerHTML = '';
                    mockData.forEach((item, i) => {
                        const div = document.createElement('div');
                        div.className = 'bg-gray-800 p-3 rounded flex justify-between items-center border border-gray-600';
                        div.innerHTML = `<div><div class="font-bold text-indigo-300 mb-1">${item.exercise}</div><div class="text-xs text-gray-400">${item.weight}kg x ${item.reps} x ${item.sets} (${item.bodyPart})</div></div><button onclick="addToCart(APP_STATE.aiResults[${i}])" class="text-xs bg-indigo-600 px-3 py-2 rounded text-white font-bold">è¿½åŠ </button>`;
                        container.appendChild(div);
                    });
                    document.getElementById('ai-result').classList.remove('hidden');
                    showLoading(false);
                 }, 1000);
                 return;
            }

            google.script.run.withSuccessHandler(res => {
                showLoading(false);
                try {
                    const data = JSON.parse(res);
                    APP_STATE.aiResults = data;

                    const container = document.getElementById('ai-result-list');
                    container.innerHTML = '';

                    data.forEach((item, i) => {
                      const div = document.createElement('div');
                      div.className = 'bg-gray-800 p-3 rounded flex justify-between items-center border border-gray-600';

                      // â˜… å®‰å…¨ã«ç¨®ç›®åã‚’ç¢ºå®š
                      const exerciseName =
                        typeof item.exercise === 'string' && item.exercise.trim()
                          ? item.exercise
                          : 'ä¸æ˜ãªç¨®ç›®';

                      div.innerHTML = `
                        <div class="flex-1 pr-2 min-w-0">
                          <a href="https://www.google.com/search?q=${encodeURIComponent(exerciseName + ' ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°')}"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="font-bold text-indigo-300 hover:text-indigo-100 flex items-center gap-1 mb-1 decoration-dotted underline underline-offset-2">
                            ${exerciseName} <i class="fas fa-search text-[10px]"></i>
                          </a>
                          <div class="text-xs text-gray-400">
                            ${item.weight}kg x ${item.reps} x ${item.sets} (${item.bodyPart})
                          </div>
                          <div class="text-[10px] text-gray-500">
                            ${item.memo || ''}
                          </div>
                        </div>
                        <button onclick="addToCart(APP_STATE.aiResults[${i}])"
                                class="text-xs bg-indigo-600 px-3 py-2 rounded text-white font-bold">
                          è¿½åŠ 
                        </button>
                      `;

                      container.appendChild(div);
                    });
                    document.getElementById('ai-result').classList.remove('hidden');
                } catch(e) { alert('AIã‚¨ãƒ©ãƒ¼: è§£æå¤±æ•—'); console.log(res); }
            }).withFailureHandler(err => { showLoading(false); alert('AIé€šä¿¡ã‚¨ãƒ©ãƒ¼: '+err); }).callGeminiAPI(prompt, USER_CONFIG.GEMINI_API_KEY);
        }
        function addAllAIItems() { APP_STATE.aiResults.forEach(item => addToCart(item)); switchTab('record'); showToast('è¿½åŠ ã—ã¾ã—ãŸ'); }

        function showLoading(b) { document.getElementById('loading-overlay').classList.toggle('hidden', !b); }
        function showToast(msg) {
            const el = document.getElementById('toast'); document.getElementById('toast-msg').textContent = msg;
            el.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => el.classList.add('opacity-0', 'pointer-events-none'), 3000);
        }
    </script>
</body>
</html>
